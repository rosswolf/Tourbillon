name: Claude Session Workflow

permissions:
  contents: write
  issues: write
  pull-requests: write

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  respond:
    if: contains(github.event.comment.body, '@claude') || contains(github.event.issue.body, '@claude')
    runs-on: [self-hosted, claude-pro]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup
        run: |
          git config --global user.name "Claude Assistant"
          git config --global user.email "claude@assistant.local"
          echo "/home/rosswolf/.npm-global/bin" >> $GITHUB_PATH
          
      - name: Add eyes emoji
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              if (context.eventName === 'issue_comment') {
                await github.rest.reactions.createForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: context.payload.comment.id,
                  content: 'eyes'
                });
              } else {
                await github.rest.reactions.createForIssue({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  content: 'eyes'
                });
              }
            } catch (e) {
              console.log('Could not add reaction');
            }
            
      - name: Get request
        id: get_request
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "${{ github.event.comment.body }}" > request.txt
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "${{ github.event.issue.body }}" > request.txt
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi
          
      - name: Call Claude
        run: |
          SESSION_ID="25fd8500-045a-4a40-bb74-f1f9e60e46ce"
          ISSUE_NUMBER="${{ steps.get_request.outputs.issue_number }}"
          
          # Test session
          echo "Testing session..." 
          TEST_OUTPUT=$(echo "What repository?" | claude --resume "$SESSION_ID" --print 2>&1 || true)
          echo "Test output: $TEST_OUTPUT"
          if echo "$TEST_OUTPUT" | grep -qi "no conversation found"; then
            echo "Session not working - cannot resume"
            echo "Session error - cannot resume session $SESSION_ID" > response.md
            exit 0
          else
            echo "Session is working!"
          fi
          
          # Only proceed if response.md doesn't exist
          if [ -f response.md ]; then
            exit 0
          fi
          
          # Build request
          REQUEST="GitHub Issue #${ISSUE_NUMBER}
          Repository: ${{ github.repository }}
          Working Directory: ${{ github.workspace }}
          
          User Request:
          $(cat request.txt)
          
          Instructions:
          - Respond helpfully to the issue/comment
          - You have full repository access
          - To create a PR:
            1. git checkout -b branch-name-$(date +%s)
            2. Make changes
            3. git add -A && git commit -m 'message'
            4. git push origin HEAD
            5. gh pr create --title 'title' --body 'body'
          - Include PR link if you create one"
          
          # Call Claude
          echo "$REQUEST" | claude --resume "$SESSION_ID" --print \
            --add-dir "${{ github.workspace }}" \
            --dangerously-skip-permissions > response.md 2>&1 || echo "Error calling Claude" > response.md
            
      - name: Post response
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const response = fs.readFileSync('response.md', 'utf8');
            const issue_number = ${{ steps.get_request.outputs.issue_number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: response
            });