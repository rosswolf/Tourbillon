name: Claude Session Workflow

permissions:
  contents: write
  issues: write
  pull-requests: write

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  respond:
    if: contains(github.event.comment.body, '@claude') || contains(github.event.issue.body, '@claude')
    runs-on: [self-hosted, claude-pro]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup
        run: |
          git config --global user.name "Claude Assistant"
          git config --global user.email "claude@assistant.local"
          echo "/home/rosswolf/.npm-global/bin" >> $GITHUB_PATH
          
      - name: Add eyes emoji
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              if (context.eventName === 'issue_comment') {
                await github.rest.reactions.createForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: context.payload.comment.id,
                  content: 'eyes'
                });
              } else {
                await github.rest.reactions.createForIssue({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  content: 'eyes'
                });
              }
            } catch (e) {
              console.log('Could not add reaction');
            }
            
      - name: Get request
        id: get_request
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "${{ github.event.comment.body }}" > request.txt
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "${{ github.event.issue.body }}" > request.txt
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi
          
      - name: Verify Claude Session
        run: |
          SESSION_ID="25fd8500-045a-4a40-bb74-f1f9e60e46ce"
          PROJECT_PATH="-home-rosswolf-Code-castlebuilder"
          
          # Since this is a self-hosted runner, session files should already be available
          SESSION_FILE="$HOME/.claude/projects/$PROJECT_PATH/${SESSION_ID}.jsonl"
          
          if [ -f "$SESSION_FILE" ]; then
            echo "✓ Session file found at: $SESSION_FILE"
            echo "  File size: $(stat -c%s "$SESSION_FILE") bytes"
            echo "  Lines: $(wc -l < "$SESSION_FILE")"
          else
            echo "✗ Session file not found at: $SESSION_FILE"
            echo "Checking claude directory structure:"
            ls -la ~/.claude/ || echo "No .claude directory"
            ls -la ~/.claude/projects/ || echo "No projects directory"
            exit 1
          fi
          
      - name: Call Claude
        run: |
          set +e  # Don't exit on error so we can handle it
          
          SESSION_ID="25fd8500-045a-4a40-bb74-f1f9e60e46ce"
          ISSUE_NUMBER="${{ steps.get_request.outputs.issue_number }}"
          
          # Using session resumption with --print flag (FIXED!)
          echo "=== Testing Claude session resumption ==="
          
          # Only proceed if response.md doesn't exist
          if [ -f response.md ]; then
            exit 0
          fi
          
          # Build request
          REQUEST="GitHub Issue #${ISSUE_NUMBER}
          Repository: ${{ github.repository }}
          Working Directory: ${{ github.workspace }}
          
          User Request:
          $(cat request.txt)
          
          Instructions:
          - Respond helpfully to the issue/comment
          - You have full repository access
          - To create a PR:
            1. git checkout -b branch-name-$(date +%s)
            2. Make changes
            3. git add -A && git commit -m 'message'
            4. git push origin HEAD
            5. gh pr create --title 'title' --body 'body'
          - Include PR link if you create one"
          
          # First, test if Claude CLI is available
          echo "Testing Claude CLI availability..."
          which claude || echo "Claude not in PATH"
          claude --version 2>&1 || echo "Could not get Claude version"
          
          # Try to resume session
          echo "Attempting to resume session: $SESSION_ID"
          echo "$REQUEST" | claude \
            --print \
            --resume "$SESSION_ID" \
            --dangerously-skip-permissions > response.md 2>error.log
          
          EXIT_CODE=$?
          
          # Check results
          if [ $EXIT_CODE -eq 0 ]; then
            echo "✓ Session resumption successful!"
          else
            echo "✗ Session resumption failed with exit code: $EXIT_CODE"
            echo "Error log content:"
            cat error.log 2>/dev/null || echo "(no error.log)"
            echo "Response content:"
            cat response.md 2>/dev/null || echo "(no response.md)"
            
            # Try fallback without session
            echo "Attempting fallback without session..."
            echo "$REQUEST" | claude --dangerously-skip-permissions > response.md 2>&1
            
            if [ $? -eq 0 ]; then
              echo "✓ Fallback successful"
            else
              echo "✗ Fallback also failed"
              echo "Creating error message..."
              echo "Error: Claude CLI is not working properly in GitHub Actions environment" > response.md
            fi
          fi
            
      - name: Post response
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const response = fs.readFileSync('response.md', 'utf8');
            const issue_number = ${{ steps.get_request.outputs.issue_number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: response
            });